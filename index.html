<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#10B981" />
    <title>MedMinder - 药安</title>
    <meta name="description" content="智能服药提醒助手" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- React and GenAI Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@18.2.0",
    "react-dom": "https://aistudiocdn.com/react-dom@18.2.0",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* 禁止iOS橡皮筋效果，提升App质感 */
      body {
        overscroll-behavior-y: none;
        -webkit-tap-highlight-color: transparent;
      }
      /* Custom Animations */
      @keyframes fade-in-up {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in-up {
        animation: fade-in-up 0.6s ease-out forwards;
      }
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 select-none">
    <div id="root"></div>

    <script>
        // Polyfill for process.env
        window.process = {
            env: {
                API_KEY: '' // API Key will be injected here
            }
        };
    </script>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
      import ReactDOM from 'react-dom';
      import { GoogleGenAI } from "@google/genai";

      // ==========================================
      // CONSTANTS & ENUMS (Converted from TS)
      // ==========================================
      const AppMode = {
        USER: 'USER',
        SUPERVISOR: 'SUPERVISOR',
      };

      const LogStatus = {
        PENDING: 'PENDING',
        TAKEN: 'TAKEN',
        SKIPPED: 'SKIPPED',
      };

      const DEFAULT_REMINDER_TIME = "08:00";
      const DEFAULT_INTERVAL = 10; // minutes

      // ==========================================
      // SERVICES
      // ==========================================
      
      // --- Storage Service ---
      const USERS_KEY = 'medminder_user';
      const LOGS_KEY = 'medminder_logs';

      const generateUUID = () => {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      };

      const getTodayDateStr = () => {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const saveLocalSettings = (settings) => {
        localStorage.setItem(USERS_KEY, JSON.stringify(settings));
      };

      const getLocalSettings = () => {
        const saved = localStorage.getItem(USERS_KEY);
        if (saved) return JSON.parse(saved);
        
        const newSettings = {
          userId: generateUUID(),
          reminderTime: "08:00",
          reminderInterval: 10,
        };
        saveLocalSettings(newSettings);
        return newSettings;
      };

      const getLocalLogs = (userId) => {
        const saved = localStorage.getItem(LOGS_KEY);
        const logs = saved ? JSON.parse(saved) : [];
        return logs.filter(l => l.userId === userId);
      };

      const saveLog = async (log) => {
        const saved = localStorage.getItem(LOGS_KEY);
        const logs = saved ? JSON.parse(saved) : [];
        
        // Remove existing log for same day if exists (overwrite logic)
        const filtered = logs.filter(l => !(l.userId === log.userId && l.dateStr === log.dateStr));
        filtered.push(log);
        
        localStorage.setItem(LOGS_KEY, JSON.stringify(filtered));
      };

      const getTodayLog = (userId) => {
        const logs = getLocalLogs(userId);
        const today = getTodayDateStr();
        return logs.find(l => l.dateStr === today) || null;
      };

      const subscribeToUserLogs = (targetUserId, callback) => {
        // Initial load
        callback(getLocalLogs(targetUserId));
        // Poll for changes
        const interval = setInterval(() => {
          callback(getLocalLogs(targetUserId));
        }, 2000);
        return () => clearInterval(interval);
      };

      const Storage = {
        generateUUID,
        getTodayDateStr,
        getLocalSettings,
        saveLocalSettings,
        getLocalLogs,
        saveLog,
        getTodayLog,
        subscribeToUserLogs
      };

      // --- Notification Service ---
      const requestNotificationPermission = async () => {
        if (!("Notification" in window)) {
          console.warn("This browser does not support desktop notification");
          return false;
        }
        if (Notification.permission === "granted") return true;
        if (Notification.permission !== "denied") {
          const permission = await Notification.requestPermission();
          return permission === "granted";
        }
        return false;
      };

      const sendNotification = (title, body) => {
        if (Notification.permission === "granted") {
          new Notification(title, {
            body,
            icon: "https://cdn-icons-png.flaticon.com/512/3022/3022668.png",
            requireInteraction: true,
            tag: "med-reminder"
          });
        }
      };

      const NotificationService = {
        requestNotificationPermission,
        sendNotification
      };

      // --- Gemini Service ---
      const getGeminiClient = () => {
        const apiKey = process.env.API_KEY;
        if (!apiKey) return null;
        return new GoogleGenAI({ apiKey });
      };

      const generateHealthTip = async () => {
        const ai = getGeminiClient();
        if (!ai) return "祝您身体健康，心情愉快！"; 

        try {
          const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: "为一位刚按时吃完药的老人生成一句简短的、温暖的、富有哲理或鼓励性的健康小贴士（20字以内）。无需标题，直接返回内容。",
          });
          return response.text.trim();
        } catch (error) {
          console.error("Gemini API error:", error);
          return "按时服药是长寿的秘诀，为您点赞！";
        }
      };

      // ==========================================
      // COMPONENTS
      // ==========================================

      // --- HistoryHeatmap Component ---
      const HistoryHeatmap = ({ logs }) => {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth(); 

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDayOfWeek = new Date(year, month, 1).getDay();

        // Fix: Removed TypeScript generic <number, LogStatus> -> new Map()
        const statusMap = useMemo(() => {
          const map = new Map();
          logs.forEach(log => {
            const [lYear, lMonth, lDay] = log.dateStr.split('-').map(Number);
            if (lYear === year && lMonth === month + 1) {
              map.set(lDay, log.status);
            }
          });
          return map;
        }, [logs, year, month]);

        const renderDays = () => {
          const grid = [];
          for (let i = 0; i < firstDayOfWeek; i++) {
            grid.push(<div key={`empty-${i}`} className="h-10 w-10" />);
          }
          for (let day = 1; day <= daysInMonth; day++) {
            const status = statusMap.get(day);
            let bgColor = 'bg-gray-100';
            let textColor = 'text-gray-400';
            
            if (status === LogStatus.TAKEN) {
              bgColor = 'bg-emerald-500 shadow-sm';
              textColor = 'text-white font-bold';
            } else if (status === LogStatus.SKIPPED) {
              bgColor = 'bg-amber-200';
              textColor = 'text-amber-700';
            }

            grid.push(
              <div 
                key={day} 
                className={`h-10 w-10 rounded-full flex items-center justify-center text-sm transition-all ${bgColor} ${textColor}`}
              >
                {day}
              </div>
            );
          }
          return grid;
        };

        return (
          <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd" />
              </svg>
              {year}年 {month + 1}月
            </h3>
            
            <div className="grid grid-cols-7 gap-2 place-items-center mb-2">
              {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                <span key={d} className="text-xs text-gray-400 font-medium">{d}</span>
              ))}
            </div>
            
            <div className="grid grid-cols-7 gap-2 place-items-center">
              {renderDays()}
            </div>

            <div className="mt-4 flex gap-4 text-xs text-gray-500 justify-center">
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 rounded-full bg-emerald-500"></div> 已服药
              </div>
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 rounded-full bg-amber-200"></div> 已跳过
              </div>
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 rounded-full bg-gray-100"></div> 未记录
              </div>
            </div>
          </div>
        );
      };

      // --- SettingsPanel Component ---
      const SettingsPanel = ({ settings, onSave }) => {
        const [time, setTime] = useState(settings.reminderTime);
        const [copied, setCopied] = useState(false);

        const handleSave = () => {
          onSave({ ...settings, reminderTime: time });
        };

        const getSupervisorLink = () => {
          const url = window.location.href.split('?')[0].split('#')[0];
          return `${url}?watch=${settings.userId}`;
        };

        const copyLink = () => {
          navigator.clipboard.writeText(getSupervisorLink());
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        };

        return (
          <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-6">
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">每日提醒时间</label>
              <div className="flex gap-2">
                <input 
                  type="time" 
                  value={time} 
                  onChange={(e) => setTime(e.target.value)}
                  className="block w-full rounded-lg border-gray-300 bg-gray-50 border p-3 text-lg focus:ring-emerald-500 focus:border-emerald-500"
                />
                <button 
                  onClick={handleSave}
                  className={`px-4 py-2 rounded-lg text-white font-medium transition-colors ${time !== settings.reminderTime ? 'bg-emerald-500' : 'bg-gray-300 cursor-default'}`}
                  disabled={time === settings.reminderTime}
                >
                  保存
                </button>
              </div>
            </div>

            <div className="pt-4 border-t border-gray-100">
              <label className="block text-sm font-medium text-gray-700 mb-2">亲友监督链接</label>
              <p className="text-xs text-gray-500 mb-3">
                将此链接发送给子女或护理人员，他们即可在手机上随时查看您的服药情况。
              </p>
              <div className="bg-gray-50 p-3 rounded-lg break-all text-xs text-gray-600 font-mono border border-gray-200 mb-3">
                {getSupervisorLink()}
              </div>
              <button 
                onClick={copyLink}
                className="w-full flex items-center justify-center gap-2 py-3 border border-emerald-500 text-emerald-600 rounded-xl font-medium active:bg-emerald-50 transition-colors"
              >
                {copied ? (
                  <>
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                    </svg>
                    已复制链接
                  </>
                ) : (
                  <>
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                    </svg>
                    复制分享链接
                  </>
                )}
              </button>
            </div>

            <div className="pt-4 border-t border-gray-100">
              <p className="text-xs text-gray-400 text-center">用户 ID: {settings.userId.substring(0, 8)}...</p>
            </div>
          </div>
        );
      };

      const NavButton = ({active, onClick, icon, label}) => (
        <button 
          onClick={onClick}
          className={`flex flex-col items-center justify-center p-2 w-16 transition-colors ${active ? 'text-emerald-600' : 'text-gray-400'}`}
        >
          <div className={`mb-1 transition-transform ${active ? 'scale-110' : ''}`}>{icon}</div>
          <span className="text-[10px] font-medium">{label}</span>
        </button>
      );

      // ==========================================
      // MAIN APP COMPONENT
      // ==========================================
      const App = () => {
        // State
        const [mode, setMode] = useState(AppMode.USER);
        const [settings, setSettings] = useState(null);
        const [todayLog, setTodayLog] = useState(null);
        const [allLogs, setAllLogs] = useState([]);
        const [activeTab, setActiveTab] = useState('home');
        const [geminiTip, setGeminiTip] = useState("");
        const [isLoadingTip, setIsLoadingTip] = useState(false);
        
        // Supervisor State
        const [watchId, setWatchId] = useState(null);
        const [watchedLogs, setWatchedLogs] = useState([]);

        // Refs for timers
        const checkTimerRef = useRef(null);

        // Initialize
        useEffect(() => {
          // 1. Check URL for Supervisor Mode
          const urlParams = new URLSearchParams(window.location.search);
          const watchParam = urlParams.get('watch');

          if (watchParam) {
            setMode(AppMode.SUPERVISOR);
            setWatchId(watchParam);
            // Start watching
            const unsubscribe = Storage.subscribeToUserLogs(watchParam, (logs) => {
              setWatchedLogs(logs);
            });
            return () => unsubscribe();
          } else {
            // 2. User Mode Init
            const localSettings = Storage.getLocalSettings();
            setSettings(localSettings);
            refreshUserLogs(localSettings.userId);
            NotificationService.requestNotificationPermission();
          }
        }, []);

        // Timer Logic for Notifications (Only in User Mode)
        useEffect(() => {
          if (mode !== AppMode.USER || !settings) return;

          const checkNotifications = () => {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            const currentTimeVal = currentHour * 60 + currentMin;

            const [schedHour, schedMin] = settings.reminderTime.split(':').map(Number);
            const schedTimeVal = schedHour * 60 + schedMin;

            const todayStr = Storage.getTodayDateStr();
            
            // If today is logged, do nothing
            if (todayLog && todayLog.dateStr === todayStr) return;

            // Check if it's time
            if (currentTimeVal >= schedTimeVal) {
              const lastNotifDate = settings.lastNotificationDate;
              const lastNotifTime = settings.lastNotificationTime || 0;
              const nowTs = Date.now();
              
              const isNewDay = lastNotifDate !== todayStr;
              const intervalPassed = (nowTs - lastNotifTime) > (settings.reminderInterval * 60 * 1000);

              if (isNewDay || intervalPassed) {
                NotificationService.sendNotification("该吃药了", "亲爱的，到了吃药的时间了，请打开药安APP记录一下。");
                
                const newSettings = {
                  ...settings,
                  lastNotificationDate: todayStr,
                  lastNotificationTime: nowTs
                };
                setSettings(newSettings);
                Storage.saveLocalSettings(newSettings);
              }
            }
          };

          checkTimerRef.current = setInterval(checkNotifications, 60000);
          checkNotifications();

          return () => {
            if (checkTimerRef.current) clearInterval(checkTimerRef.current);
          };
        }, [mode, settings, todayLog]);

        const refreshUserLogs = (userId) => {
          const logs = Storage.getLocalLogs(userId);
          setAllLogs(logs);
          const todayStr = Storage.getTodayDateStr();
          const tLog = logs.find(l => l.dateStr === todayStr);
          setTodayLog(tLog || null);
          if (tLog?.note) setGeminiTip(tLog.note);
        };

        const handleTakeMedication = useCallback(async () => {
          if (!settings) return;
          
          if (window.confetti) {
            window.confetti({
              particleCount: 150,
              spread: 70,
              origin: { y: 0.6 },
              colors: ['#10B981', '#34D399', '#FCD34D']
            });
          }

          // Simple beep logic using AudioContext
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.5, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
          } catch (e) { console.error(e) }
      
          const todayStr = Storage.getTodayDateStr();
          
          const newLog = {
            id: Storage.generateUUID(),
            userId: settings.userId,
            dateStr: todayStr,
            timestamp: Date.now(),
            status: LogStatus.TAKEN
          };

          setTodayLog(newLog);
          await Storage.saveLog(newLog);
          refreshUserLogs(settings.userId);

          // Call Gemini
          if (process.env.API_KEY) {
            setIsLoadingTip(true);
            const tip = await generateHealthTip();
            setGeminiTip(tip);
            setIsLoadingTip(false);
            
            newLog.note = tip;
            await Storage.saveLog(newLog);
            refreshUserLogs(settings.userId);
          } else {
            setGeminiTip("今日已打卡，愿您健康常伴！");
          }

        }, [settings]);

        const handleSkip = async () => {
          if (!settings) return;
          const todayStr = Storage.getTodayDateStr();
          const newLog = {
            id: Storage.generateUUID(),
            userId: settings.userId,
            dateStr: todayStr,
            timestamp: Date.now(),
            status: LogStatus.SKIPPED
          };
          setTodayLog(newLog);
          await Storage.saveLog(newLog);
          refreshUserLogs(settings.userId);
        };

        const handleUpdateSettings = (newSettings) => {
          setSettings(newSettings);
          Storage.saveLocalSettings(newSettings);
        };

        // --- RENDER ---

        if (mode === AppMode.SUPERVISOR) {
          const todayStr = Storage.getTodayDateStr();
          const todayStatus = watchedLogs.find(l => l.dateStr === todayStr);

          return (
            <div className="min-h-screen bg-gray-50 flex flex-col">
              <header className="bg-white shadow-sm p-4 sticky top-0 z-10">
                <div className="max-w-md mx-auto flex items-center justify-between">
                  <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span className="bg-indigo-600 text-white p-1 rounded-md">监</span>
                    亲友监督模式
                  </h1>
                  <a href="/" className="text-sm text-gray-500 underline">返回我的主页</a>
                </div>
              </header>

              <main className="flex-1 p-4 max-w-md mx-auto w-full space-y-6">
                <div className={`rounded-2xl p-6 text-center text-white shadow-lg transition-colors duration-500 ${
                  todayStatus?.status === LogStatus.TAKEN ? 'bg-emerald-500' : 
                  todayStatus?.status === LogStatus.SKIPPED ? 'bg-amber-400' : 'bg-rose-500'
                }`}>
                  <p className="opacity-80 mb-2 font-medium">今日状态</p>
                  <h2 className="text-3xl font-bold mb-2">
                    {todayStatus?.status === LogStatus.TAKEN ? '已服药' : 
                    todayStatus?.status === LogStatus.SKIPPED ? '已跳过' : '等待服药'}
                  </h2>
                  <p className="text-sm opacity-90">
                    {todayStatus ? new Date(todayStatus.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'}) : '尚未记录'}
                  </p>
                </div>

                <HistoryHeatmap logs={watchedLogs} />
                
                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                  <h4 className="font-bold text-blue-800 mb-1">小贴士</h4>
                  <p className="text-sm text-blue-600">此页面数据会实时更新，您无需手动刷新。请将其添加到浏览器书签以便随时查看。</p>
                </div>
              </main>
            </div>
          );
        }

        const todayDate = new Date();
        const dateStr = todayDate.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });

        return (
          <div className="min-h-screen bg-gray-50 flex flex-col pb-24">
            {activeTab === 'home' && (
              <main className="flex-1 flex flex-col p-6 max-w-md mx-auto w-full">
                <header className="mb-8 mt-4">
                  <p className="text-gray-500 text-lg mb-1">你好,</p>
                  <h1 className="text-3xl font-bold text-gray-800">{dateStr}</h1>
                  <p className="text-emerald-600 text-sm font-medium mt-2 bg-emerald-50 inline-block px-3 py-1 rounded-full">
                    提醒时间: {settings?.reminderTime}
                  </p>
                </header>

                <div className="flex-1 flex flex-col items-center justify-center space-y-8">
                  {todayLog?.status === LogStatus.TAKEN ? (
                    <div className="text-center animate-fade-in-up">
                      <div className="w-48 h-48 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-24 w-24 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                      <h2 className="text-2xl font-bold text-gray-800 mb-2">今日已服药</h2>
                      <p className="text-gray-500">{new Date(todayLog.timestamp).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})} 完成</p>
                      
                      {(geminiTip || isLoadingTip) && (
                        <div className="mt-8 p-4 bg-white rounded-xl shadow-sm border border-emerald-100 max-w-xs mx-auto">
                          <p className="text-xs font-bold text-emerald-500 mb-2 uppercase tracking-wide">每日健康语</p>
                          {isLoadingTip ? (
                            <div className="animate-pulse h-4 bg-gray-200 rounded w-3/4 mx-auto"></div>
                          ) : (
                            <p className="text-gray-700 italic font-medium leading-relaxed">“{geminiTip}”</p>
                          )}
                        </div>
                      )}
                    </div>
                  ) : todayLog?.status === LogStatus.SKIPPED ? (
                    <div className="text-center">
                      <div className="w-40 h-40 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                          <span className="text-4xl">⏸️</span>
                      </div>
                      <h2 className="text-xl font-bold text-gray-600">今日已跳过</h2>
                      <button onClick={() => setTodayLog(null)} className="mt-4 text-emerald-600 text-sm font-medium underline">
                        撤销操作
                      </button>
                    </div>
                  ) : (
                    <div className="flex flex-col items-center w-full">
                      <button 
                        onClick={handleTakeMedication}
                        className="group relative w-56 h-56 rounded-full bg-emerald-500 shadow-xl shadow-emerald-200 flex flex-col items-center justify-center text-white transition-all active:scale-95 active:shadow-md hover:bg-emerald-600"
                      >
                        <div className="absolute inset-0 rounded-full border-4 border-white opacity-20 scale-90 group-hover:scale-100 transition-transform"></div>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-20 w-20 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        <span className="text-2xl font-bold tracking-wider">服药啦</span>
                      </button>
                      
                      <button 
                        onClick={handleSkip}
                        className="mt-8 px-6 py-2 rounded-full text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition-colors text-sm font-medium"
                      >
                        今日跳过
                      </button>
                    </div>
                  )}
                </div>
              </main>
            )}

            {activeTab === 'history' && (
              <main className="flex-1 p-6 max-w-md mx-auto w-full">
                <h2 className="text-2xl font-bold text-gray-800 mb-6">历史记录</h2>
                <HistoryHeatmap logs={allLogs} />
              </main>
            )}

            {activeTab === 'settings' && settings && (
              <main className="flex-1 p-6 max-w-md mx-auto w-full">
                <h2 className="text-2xl font-bold text-gray-800 mb-6">设置与监督</h2>
                <SettingsPanel settings={settings} onSave={handleUpdateSettings} />
              </main>
            )}

            <nav className="fixed bottom-0 w-full bg-white border-t border-gray-100 pb-safe pt-2 px-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
              <div className="max-w-md mx-auto flex justify-around">
                <NavButton 
                  active={activeTab === 'home'} 
                  onClick={() => setActiveTab('home')} 
                  icon={<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>}
                  label="打卡"
                />
                <NavButton 
                  active={activeTab === 'history'} 
                  onClick={() => setActiveTab('history')} 
                  icon={<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>}
                  label="历史"
                />
                <NavButton 
                  active={activeTab === 'settings'} 
                  onClick={() => setActiveTab('settings')} 
                  icon={<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>}
                  label="设置"
                />
              </div>
            </nav>
          </div>
        );
      };

      // Fix: Use ReactDOM.render instead of createRoot
      const rootElement = document.getElementById('root');
      ReactDOM.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>,
        rootElement
      );
    </script>
  </body>
</html>
